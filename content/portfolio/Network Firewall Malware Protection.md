---
title: "VPC Malware Protection Using AWS Network Firewall"
date: 2025-10-13
tags: ["AWS Network Firewall", "VPC", "Suricata", "Malware", "AWS CLI", "SSH"]
categories: ["Cloud", "AWS", "Networking", "Security"]
description: "Implemented a stateful inspection perimeter using AWS Network Firewall. I configured custom Suricata rules to block outbound traffic to known malicious domains."
featured_image: "images/network-firewall.jpeg"
draft: false
show: default
---

[AWS Network Firewall](https://aws.amazon.com/network-firewall/) is a managed service that makes it easy to deploy essential network protections for all of your Amazon Virtual Private Clouds (VPCs). It's a stateful, managed network firewall and intrusion detection and prevention service that provides granular traffic filtering.

## Scenario

The security team at CafeCompany is concerned about workloads accidentally downloading malware after accessing specific websites. There have been reports of users accessing these sites, which could lead to a compromised environment.

CafeCompany has provided me with the URLs of the sites hosting the malware. As a security engineer, my task is to implement a solution that blocks this traffic at the network perimeter, preventing any instance within their VPC from accessing these malicious files.

{{< note type="info">}}
This is a fictional scenario that is simulated within a lab environment.
{{< /note >}}

## Architecture

{{< terminal-figure src="network-firewall-architecture.png" alt="AWS Network Firewall Architecture" align="center">}}

## Step 1: Establishing a Baseline

My first action was to validate the problem. I needed to confirm that the test instance could, in its current state, access and download the malicious files.

1.  I connected to the `TestInstance` (an EC2 instance in a private subnet) using AWS Systems Manager Session Manager.
2.  From the terminal, I simulated a user downloading the malicious files using `wget`.

{{< note type="warning">}}
**Note on Test URLs:** The `malware.wicar.org` domain is a benign site used specifically to test anti-malware rules. While the files are harmless, it is a security best practice to never run `wget` or `curl` on unknown links outside of a secure, isolated lab environment.
{{< /note >}}

```bash
cd ~

# Attempt to download the first malware test file
wget [http://malware.wicar.org/data/js_crypto_miner.html](http://malware.wicar.org/data/js_crypto_miner.html)

# Attempt to download the second malware test file
wget [http://malware.wicar.org/data/java_jre17_exec.html](http://malware.wicar.org/data/java_jre17_exec.html)
````

The output showed a `200 OK` status, and the files were saved successfully.



```bash
--2025-10-23 14:30:00--  [http://malware.wicar.org/data/js_crypto_miner.html](http://malware.wicar.org/data/js_crypto_miner.html)
Resolving malware.wicar.org (malware.wicar.org)... 10.0.0.1
Connecting to malware.wicar.org (malware.wicar.org)|10.0.0.1|:80... connected.
HTTP request sent, awaiting response... 200 OK
Length: 2166 (2.1K) [text/html]
Saving to: 'js_crypto_miner.html'

js_crypto_miner.html      100%[===================================>]   2.12K  --.-KB/s    in 0s      

2025-10-23 14:30:00 (150 MB/s) - 'js_crypto_miner.html' saved [2166/2166]
```

I confirmed the files were present with the `ls` command. This successfully replicated the security risk: workloads inside the VPC were vulnerable.

```bash
$ ls
java_jre17_exec.html  js_crypto_miner.html
```

## Step 2: Configuring the Firewall

With the baseline confirmed, I navigated to the pre-configured `LabFirewall` in the VPC console.

The key to this solution is ensuring the firewall performs deep packet inspection, not just basic stateless filtering. To do this, I edited the associated `LabFirewallPolicy`.

By default, the **Stateless default action** was set to `pass`. I changed this to **Forward to stateful rule groups**. This critical change ensures that all packets are sent to the stateful engine for deeper, contextual inspection against our threat-intelligence rules.

## Step 3: Creating the Suricata Rule Group

This is the core of the solution. I needed to create a rule set that specifically identifies and blocks the malicious URLs.

1. I navigated to **Network Firewall Rule Groups** and chose to create a new **Stateful rule group**.
    
2. I configured it with a `Capacity` of `100` and set the **Rule group format** to **Suricata compatible rule string**.
    

Inside the rule editor, I added the following two Suricata rules. These rules instruct the firewall to `drop` (block) any `http` traffic destined for port 80 that contains the specific `http_uri` content of the malicious files.

```bash
drop http $HOME_NET any -> $EXTERNAL_NET 80 (msg:"MALWARE custom solution"; flow: to_server,established; classtype:trojan-activity; sid:2002001; content:"/data/js_crypto_miner.html";http_uri; rev:1;)

drop http $HOME_NET any -> $EXTERNAL_NET 80 (msg:"MALWARE custom solution"; flow: to_server,established; classtype:trojan-activity; sid:2002002; content:"/data/java_jre17_exec.html";http_uri; rev:1;)
```

I named this group `StatefulRuleGroup` and saved it.

## Step 4: Activating the New Rule

With the rule group built, I returned to the `LabFirewallPolicy`.

In the **Stateful rule groups** section, I used the "Add unmanaged stateful rule groups" option to add my newly created `StatefulRuleGroup` to the policy.

This action activated the rules, and the Network Firewall began inspecting all forwarded traffic against my custom Suricata signatures.

## Step 5: Validating

The final and most important step was to test the fix. I re-connected to the `TestInstance` via Session Manager and ran the `wget` commands from Step 1.

Bash

```
# Re-attempt the download
wget [http://malware.wicar.org/data/js_crypto_miner.html](http://malware.wicar.org/data/js_crypto_miner.html)
```

The result was a success. The command now hangs at `HTTP request sent, awaiting response...` and eventually times out.

Bash

```
--2025-10-23 14:45:00--  [http://malware.wicar.org/data/js_crypto_miner.html](http://malware.wicar.org/data/js_crypto_miner.html)
Resolving malware.wicar.org (malware.wicar.org)... 10.0.0.1
Connecting to malware.wicar.org (malware.wicar.org)|10.0.0.1|:80... connected.
HTTP request sent, awaiting response...
```

This confirms the Network Firewall is successfully inspecting the traffic, matching the Suricata rule, and dropping the packet before the malicious file can be downloaded. The same result occurred for the second URL.

To finish, I removed the test files that were downloaded during the initial baseline test.

Bash

```
# Clean up the test files from Step 1
rm java_jre17_exec.html js_crypto_miner.html
```

## Improvements

Instead of manually writing and maintaining custom Suricata rules, the most significant improvement is to use `AWS Managed Rule Groups`. These are curated, automatically updated threat-intelligence lists maintained by AWS and its security partners. By adding rule groups like "Known malicious domains" or "Botnet command and control," the firewall can block thousands of emerging threats with minimal effort.

My Suricata rules were for specific **URIs**. For broader filtering, such as blocking entire domains (malware.wicar.org) or enforcing company policy (e.g., blocking facebook.com), a Stateful Domain List rule group is more efficient.

## Conclusion

This project successfully implemented a stateful, centralized firewall to protect VPC workloads. By leveraging AWS Network Firewall and custom Suricata rules, I demonstrated how to block outbound connections to specific malicious sites, mitigating the risk of malware infection.

This solution is highly scalable and immediately hardens the 'CafeCompany' security posture. The same principles could be used to add AWS Managed Rule Groups, providing automated protection against thousands of known, emerging threats without needing to manage individual rules.

